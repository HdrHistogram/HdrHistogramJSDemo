<html>

<head>
    <meta charset="UTF-8">
    <style type="text/css">
        div.histo {
            visibility: hidden
        }
    </style>

    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="lib/pako.min.js"></script>
    <script type="text/javascript" src="lib/hdrhistogram.umd.js"></script>
    <script type="text/javascript" src="logparser.js"></script>


    <!--
 WARNING quick'n'dirty code down here :(
-->
    <script type="text/javascript">


        if (window.File && window.FileReader && window.FileList && window.Blob) {
            // Great success! All the File APIs are supported.
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }

        // Load the Visualization API and the piechart package.
        google.load('visualization', '1.0', { 'packages': ['corechart', 'annotationchart'] });

        const parseUrl = searchString => {
            const equalIndex = searchString.indexOf('=');
            if (equalIndex > 0) {
                return decodeURI(searchString.substring(equalIndex + 1));
            }
            return 'https://raw.githubusercontent.com/HdrHistogram/HdrHistogramJS/master/test_files/jHiccup-2.0.7S.logV2.hlog';
        }

        var logs = null;

        const rangeDataHandler = ({ data }) => {
            if (data.errorRaised) {
                document.getElementById('chart_div').innerHTML = `<span style="color:red">Percentiles could not be computed, please reduce the time range</span>`
            } else {
                drawChart(data.histogram);
            }
        };

        const fullFileDataHandler = ({ data }) => {
            drawMaxChart(data.tags, data.maxDataRows);
            rangeDataHandler({ data });
        }

        const newFileDataHandler = ({ data }) => {
            fullFileDataHandler({ data });
            drawMetricsToggles(data.tags);
        }


        // Set a callback to run when the Google Visualization API is loaded.
        google.setOnLoadCallback(function () {
            document.getElementById('files').addEventListener('change', handleFileSelect, false);
            const url = parseUrl(window.location.search);
            fetch(url)
                .then(response => response.text())
                .then(content => {
                    logs = content;
                    mediator.registerRangeDataCb(rangeDataHandler);
                    mediator.registerFullFileDataCb(fullFileDataHandler);
                    mediator.registerNewFileDataCb(newFileDataHandler);
                    mediator.registerReadyCb(displayLogs);
                });
        });

        var chart = null;
        var maxChart = null;

        // initialized in jhiccup.log.example.js
        //var logs = null;

        var maxPercentile = 1000000;

        var latestChartData;
        function drawChart(chartData) {

            if (chartData) {
                latestChartData = chartData;
            } else {
                chartData = latestChartData;
            }

            var ticks =
                [{ v: 1, f: '0%' },
                { v: 10, f: '90%' },
                { v: 100, f: '99%' },
                { v: 1000, f: '99.9%' },
                { v: 10000, f: '99.99%' },
                { v: 100000, f: '99.999%' },
                { v: 1000000, f: '99.9999%' },
                { v: 10000000, f: '99.99999%' },
                { v: 100000000, f: '99.999999%' }];

            var unitSelection = document.getElementById("timeUnitSelection");
            var unitSelIndex = unitSelection.selectedIndex;
            var unitText = unitSelection.options[unitSelIndex].innerHTML;

            var options = {
                title: 'Latency by Percentile Distribution',
                height: 480,
                hAxis: {
                    title: "Percentile",
                    minValue: 1, logScale: true, ticks: ticks,
                    viewWindowMode: 'explicit',
                    viewWindow: {
                        max: maxPercentile,
                        min: 1
                    }
                },
                vAxis: { title: 'Latency (' + unitText + ')', minValue: 0 },
                legend: { position: 'bottom' }
            };

            if (chart == null) {
                chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            }

            // add tooptips with correct percentile text to data:
            var columns = [0];
            for (var i = 1; i < chartData.getNumberOfColumns(); i++) {
                columns.push(i);
                columns.push({
                    type: 'string',
                    properties: {
                        role: 'tooltip'
                    },
                    calc: (function (j) {
                        return function (dt, row) {
                            var percentile = 100.0 - (100.0 / dt.getValue(row, 0));
                            return dt.getColumnLabel(j) + ': ' +
                                percentile.toPrecision(7) +
                                '\%\'ile = ' + dt.getValue(row, j) + ' ' + unitText
                        }
                    })(i)
                });
            }
            var view = new google.visualization.DataView(chartData);
            view.setColumns(columns);

            chart.draw(view, options);

        }

        function drawMaxChart(tags, rawData) {
            var data = new google.visualization.DataTable();
            data.addColumn('datetime', 'Date');
            tags.forEach(tag => data.addColumn('number', tag));

            data.addRows(rawData);

            if (maxChart) {
                maxChart.clearChart();
            }

            maxChart = new google.visualization.AnnotationChart(document.getElementById('max_chart_div'));


            var options = {
                displayAnnotations: false,
                displayZoomButtons: false
            };

            maxChart.draw(data, options);

            google.visualization.events.addListener(maxChart, 'rangechange', debounce(rangechange_handler, 200));

            function debounce(callback, delay) {
                var timer;
                return function () {
                    var args = arguments;
                    var context = this;
                    clearTimeout(timer);
                    timer = setTimeout(function () {
                        callback.apply(context, args);
                    }, delay)
                }
            }

            function rangechange_handler(e) {
                mediator.changeRange(e.start, e.end);
            }
        }

        function timeUnitsSelected(evt) {
            drawChart();
        }


        function displayLogs() {
            mediator.newLogFile(logs);
        }

        let ignoredMetrics = {};

        function toggleMetric(tag) {
            mediator.toggleMetric(tag);
        }

        function drawMetricsToggles(tags) {
            const content = tags.reduce(((buffer, tag) => {
                return buffer + ' ' + `<input type="checkbox" id="toggle_${tag}" onclick="toggleMetric('${tag}');" checked><label for="toggle_${tag}">${tag}</label>`;
            }), "<fieldset><legend>Metric toggles</legend>") + '</fieldset>';

            document.getElementById('metric_toggles').innerHTML = content;
        }

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object

            var names = [];
            var histos = [];
            var fileCount = 0;

            // Loop through the FileList and render image files as thumbnails.
            for (var i = 0, f; f = files[i]; i++) {
                var reader = new FileReader();

                reader.onload = (function (theFile) {
                    return function (e) {
                        ignoredMetrics = {};
                        logs = e.target.result;
                        displayLogs();
                    };
                })(f);

                // Read in the image file as a data URL.
                reader.readAsText(f);
            }

        }


    </script>

    <style>
        .slider-width500 {
            width: 500px;
        }
    </style>

</head>

<body>
    <h2>HdrHistogram simple log analyzer</h2>

    <input type="file" id="files" name="files[]" multiple />


    <div id="max_chart_div" style="height: 200px"></div>
    <div style="height: 300px">
        <div id="chart_div">None Loaded</div>

        Latency time units:
        <select name="units" size="1" id="timeUnitSelection" onChange="timeUnitsSelected()">
            <option value="Latency (seconds)">seconds</option>
            <option selected value="Latency (milliseconds)">milliseconds</option>
            <option value="Latency (Âµs)">microseconds</option>
            <option value="Latency (nanoseconds)">nanoseconds</option>
        </select>

        &nbsp; &nbsp; &nbsp; &nbsp;
        <p>
            Percentile range:

            <input type="range" class="slider-width500" min="1" max="8" value="7" step="1" width="300px"
                onchange="showValue(this.value)" />
            <span id="percentileRange">99.99999%</span>
            <script type="text/javascript">
                function showValue(newValue) {
                    var x = Math.pow(10, newValue);
                    percentile = 100.0 - (100.0 / x);
                    document.getElementById("percentileRange").innerHTML = percentile + "%";
                    maxPercentile = x;
                    drawChart();
                }
            </script>
        </p>
        <div id="metric_toggles"></div>
    </div>
</body>

</html>